{"ast":null,"code":"import { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nvar _jsxFileName = \"/home/abrikos/WebstormProjects/math/src/pages/admin/AdminModel.js\",\n    _s = $RefreshSig$();\n\nimport React, { useEffect, useState } from \"react\";\nimport { Button, Form } from \"react-bootstrap\";\nimport { A, navigate } from \"hookrouter\";\nimport FileUpload from \"components/file-list/FileUpload\";\nimport FileList from \"components/file-list/FileList\";\nimport InputModel from \"components/inputModel/InputModel\";\nimport Pager from \"components/Pager\";\nexport default function AdminModel(props) {\n  _s();\n\n  const [edited, setEdited] = useState(false);\n  const [schema, setSchema] = useState();\n  const [totalCount, setTotalCount] = useState(0);\n  const [list, setList] = useState([]);\n  const [model, setModel] = useState();\n  const [errors, setErrors] = useState({});\n  const [filter, setFilter] = useState({});\n  const modelName = props.control;\n  useEffect(init, [props, modelName]);\n\n  function init() {\n    props.store.api(`/${modelName}/schema`).then(s => {\n      setModel(null);\n      setSchema(s);\n      setFilter(s);\n      console.log('zzUUcc', s);\n      const f = {\n        limit: 10\n      };\n      f.order = s.formOptions.listOrder;\n      console.log('zzzzzzzzzzzzz', s);\n      getList(f);\n      if (props.id) props.store.api(`/${modelName}/${props.id}/view`).then(setModel);\n    });\n  }\n\n  function getList(f) {\n    setFilter(f);\n    props.store.api(`/${modelName}/list`, f).then(res => {\n      setList(res.list);\n      setTotalCount(res.count);\n    });\n  }\n\n  function create() {\n    props.store.api(`/admin/${modelName}/create`).then(model => {\n      navigate(model.adminLink);\n    });\n  }\n\n  function submit(e) {\n    e.preventDefault();\n    const form = props.store.formToObject(e.target);\n    const err = {};\n\n    for (const f of schema.fields) {\n      if (f.options.required && !form[f.name]) err[f.name] = f.options.label + ' обязательно';\n    }\n\n    if (Object.keys(err).length) return setErrors(err);\n    setErrors({});\n\n    if (model.id) {\n      console.log(form);\n      props.store.api(`/admin/${modelName}/${model.id}/update`, form).then(() => {\n        getList(filter);\n        setEdited(false);\n      });\n    } else {\n      create(form);\n    }\n  }\n\n  function uploadDone(files) {\n    props.store.api(`/admin/${modelName}/${model.id}/files/add`, {\n      files\n    }).then(setModel);\n  }\n\n  function setPreview(img) {\n    props.store.api(`/admin/${modelName}/${model.id}/file-preview/${img.id}`).then(setModel);\n  }\n\n  function pageChange(f) {\n    getList(f);\n  }\n\n  function search(e) {\n    e.preventDefault();\n    const form = props.store.formToObject(e.target);\n    const f = { ...filter\n    };\n    f.regexp = schema.formOptions.searchFields.map(p => {\n      const o = {};\n      o[p] = form.search;\n      return o;\n    });\n    getList(f);\n  }\n\n  function deleteModel() {\n    if (!window.confirm(`Удалить ${schema.formOptions.label}?`)) return;\n    props.store.api(`/admin/${modelName}/${model.id}/delete`).then(() => {\n      setModel(null);\n      getList(filter);\n    });\n  }\n\n  if (!schema) return /*#__PURE__*/_jsxDEV(\"div\", {}, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 110,\n    columnNumber: 25\n  }, this);\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    children: [!model && /*#__PURE__*/_jsxDEV(\"div\", {\n      children: [/*#__PURE__*/_jsxDEV(Button, {\n        onClick: create,\n        variant: \"primary\",\n        children: [\"\\u0441\\u043E\\u0437\\u0434\\u0430\\u0442\\u044C \\\"\", schema.formOptions.label, \"\\\"\"]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 113,\n        columnNumber: 13\n      }, this), /*#__PURE__*/_jsxDEV(\"form\", {\n        onSubmit: search,\n        children: [/*#__PURE__*/_jsxDEV(\"input\", {\n          name: \"search\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 115,\n          columnNumber: 17\n        }, this), /*#__PURE__*/_jsxDEV(Button, {\n          children: \"\\u041F\\u043E\\u0438\\u0441\\u043A\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 116,\n          columnNumber: 17\n        }, this), /*#__PURE__*/_jsxDEV(Button, {\n          type: \"cancel\",\n          children: \"\\u0425\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 117,\n          columnNumber: 17\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 114,\n        columnNumber: 13\n      }, this), /*#__PURE__*/_jsxDEV(\"table\", {\n        className: \"table table-striped\",\n        children: /*#__PURE__*/_jsxDEV(\"tbody\", {\n          children: list.map(l => /*#__PURE__*/_jsxDEV(\"tr\", {\n            children: [/*#__PURE__*/_jsxDEV(\"td\", {\n              children: /*#__PURE__*/_jsxDEV(A, {\n                href: `/admin/${modelName}/${l.id}/update`,\n                className: `d-block ${model && l.id === model.id ? 'bg-success' : ''}`,\n                children: schema.formOptions.listFields.map(f => l[f]).join(' - ') || l.id\n              }, l.id, false, {\n                fileName: _jsxFileName,\n                lineNumber: 123,\n                columnNumber: 25\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 122,\n              columnNumber: 21\n            }, this), /*#__PURE__*/_jsxDEV(\"td\", {\n              children: l.image && /*#__PURE__*/_jsxDEV(\"img\", {\n                src: l.photo,\n                alt: l.id,\n                height: 20\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 128,\n                columnNumber: 37\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 127,\n              columnNumber: 21\n            }, this)]\n          }, l.id, true, {\n            fileName: _jsxFileName,\n            lineNumber: 121,\n            columnNumber: 32\n          }, this))\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 120,\n          columnNumber: 17\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 119,\n        columnNumber: 13\n      }, this), \"\\u041D\\u0430\\u0439\\u0434\\u0435\\u043D\\u043E: \", totalCount, !!totalCount && /*#__PURE__*/_jsxDEV(Pager, {\n        count: totalCount,\n        filter: filter,\n        onPageChange: pageChange\n      }, totalCount, false, {\n        fileName: _jsxFileName,\n        lineNumber: 135,\n        columnNumber: 30\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 112,\n      columnNumber: 20\n    }, this), model && /*#__PURE__*/_jsxDEV(\"div\", {\n      children: [/*#__PURE__*/_jsxDEV(Button, {\n        onClick: () => navigate(`/admin/${modelName}`),\n        variant: \"warning\",\n        children: \"\\u0417\\u0430\\u043A\\u0440\\u044B\\u0442\\u044C\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 138,\n        columnNumber: 13\n      }, this), /*#__PURE__*/_jsxDEV(A, {\n        href: model.link,\n        children: \"\\u0421\\u043C\\u043E\\u0442\\u0440\\u0435\\u0442\\u044C\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 139,\n        columnNumber: 13\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"row\",\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"col-10\",\n          children: /*#__PURE__*/_jsxDEV(Form, {\n            validated: false,\n            onSubmit: submit,\n            onChange: () => setEdited(true),\n            className: \"form-model\",\n            children: [edited && /*#__PURE__*/_jsxDEV(Button, {\n              type: \"submit\",\n              children: \"\\u0421\\u043E\\u0445\\u0440\\u0430\\u043D\\u0438\\u0442\\u044C\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 143,\n              columnNumber: 36\n            }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n              className: \"admin-form-fields\",\n              children: schema.fields.map(f => /*#__PURE__*/_jsxDEV(InputModel, {\n                modelName: modelName,\n                model: model,\n                field: f,\n                errors: errors,\n                store: props.store\n              }, f.name, false, {\n                fileName: _jsxFileName,\n                lineNumber: 145,\n                columnNumber: 53\n              }, this))\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 144,\n              columnNumber: 25\n            }, this), edited && /*#__PURE__*/_jsxDEV(Button, {\n              type: \"submit\",\n              children: \"\\u0421\\u043E\\u0445\\u0440\\u0430\\u043D\\u0438\\u0442\\u044C\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 147,\n              columnNumber: 36\n            }, this)]\n          }, model.id, true, {\n            fileName: _jsxFileName,\n            lineNumber: 142,\n            columnNumber: 21\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 141,\n          columnNumber: 17\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"col-2\",\n          children: [/*#__PURE__*/_jsxDEV(\"img\", {\n            src: model.previewPath,\n            alt: model.id,\n            className: \"img-fluid\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 152,\n            columnNumber: 21\n          }, this), /*#__PURE__*/_jsxDEV(FileUpload, {\n            uploadDone: uploadDone,\n            store: props.store\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 153,\n            columnNumber: 21\n          }, this), model.files && /*#__PURE__*/_jsxDEV(FileList, {\n            setPreview: setPreview,\n            files: model.files.filter(i => i.isImage),\n            editable: true,\n            store: props.store\n          }, model.files.length, false, {\n            fileName: _jsxFileName,\n            lineNumber: 154,\n            columnNumber: 37\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 151,\n          columnNumber: 17\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 140,\n        columnNumber: 13\n      }, this), /*#__PURE__*/_jsxDEV(Button, {\n        onClick: deleteModel,\n        variant: \"danger\",\n        children: \"\\u0423\\u0434\\u0430\\u043B\\u0438\\u0442\\u044C\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 164,\n        columnNumber: 13\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 137,\n      columnNumber: 19\n    }, this)]\n  }, modelName, true, {\n    fileName: _jsxFileName,\n    lineNumber: 111,\n    columnNumber: 12\n  }, this);\n}\n\n_s(AdminModel, \"g+1F8b5SXgh2yQvLGIRIn8YSVJA=\");\n\n_c = AdminModel;\n\nvar _c;\n\n$RefreshReg$(_c, \"AdminModel\");","map":{"version":3,"sources":["/home/abrikos/WebstormProjects/math/src/pages/admin/AdminModel.js"],"names":["React","useEffect","useState","Button","Form","A","navigate","FileUpload","FileList","InputModel","Pager","AdminModel","props","edited","setEdited","schema","setSchema","totalCount","setTotalCount","list","setList","model","setModel","errors","setErrors","filter","setFilter","modelName","control","init","store","api","then","s","console","log","f","limit","order","formOptions","listOrder","getList","id","res","count","create","adminLink","submit","e","preventDefault","form","formToObject","target","err","fields","options","required","name","label","Object","keys","length","uploadDone","files","setPreview","img","pageChange","search","regexp","searchFields","map","p","o","deleteModel","window","confirm","l","listFields","join","image","photo","link","previewPath","i","isImage"],"mappings":"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","sourcesContent":["import React, {useEffect, useState} from \"react\";\nimport {Button, Form} from \"react-bootstrap\";\nimport {A, navigate} from \"hookrouter\";\nimport FileUpload from \"components/file-list/FileUpload\";\nimport FileList from \"components/file-list/FileList\";\nimport InputModel from \"components/inputModel/InputModel\";\nimport Pager from \"components/Pager\";\n\n\nexport default function AdminModel(props) {\n    const [edited, setEdited] = useState(false);\n    const [schema, setSchema] = useState();\n    const [totalCount, setTotalCount] = useState(0);\n    const [list, setList] = useState([]);\n    const [model, setModel] = useState();\n    const [errors, setErrors] = useState({});\n    const [filter, setFilter] = useState({});\n    const modelName = props.control;\n\n    useEffect(init, [props, modelName]);\n\n    function init() {\n        props.store.api(`/${modelName}/schema`)\n            .then(s => {\n                setModel(null)\n                setSchema(s);\n                setFilter(s)\n                console.log('zzUUcc', s)\n                const f = {limit: 10}\n                f.order = s.formOptions.listOrder;\n                console.log('zzzzzzzzzzzzz',s)\n                getList(f);\n                if (props.id) props.store.api(`/${modelName}/${props.id}/view`).then(setModel)\n            })\n    }\n\n    function getList(f) {\n        setFilter(f)\n        props.store.api(`/${modelName}/list`, f).then(res => {\n            setList(res.list)\n            setTotalCount(res.count)\n        })\n    }\n\n    function create() {\n        props.store.api(`/admin/${modelName}/create`)\n            .then(model => {\n                navigate(model.adminLink)\n            })\n    }\n\n    function submit(e) {\n        e.preventDefault();\n        const form = props.store.formToObject(e.target);\n\n        const err = {};\n        for (const f of schema.fields) {\n            if (f.options.required && !form[f.name]) err[f.name] = f.options.label + ' обязательно';\n        }\n        if (Object.keys(err).length) return setErrors(err);\n        setErrors({});\n        if (model.id) {\n            console.log(form)\n            props.store.api(`/admin/${modelName}/${model.id}/update`, form)\n                .then(() => {\n                    getList(filter);\n                    setEdited(false)\n                })\n        } else {\n            create(form)\n        }\n\n    }\n\n    function uploadDone(files) {\n        props.store.api(`/admin/${modelName}/${model.id}/files/add`, {files})\n            .then(setModel)\n    }\n\n    function setPreview(img) {\n        props.store.api(`/admin/${modelName}/${model.id}/file-preview/${img.id}`)\n            .then(setModel)\n    }\n\n\n    function pageChange(f) {\n        getList(f)\n    }\n\n    function search(e) {\n        e.preventDefault()\n        const form = props.store.formToObject(e.target);\n        const f = {...filter}\n        f.regexp = schema.formOptions.searchFields.map(p => {\n            const o = {};\n            o[p] = form.search\n            return o\n        })\n        getList(f)\n    }\n\n    function deleteModel() {\n        if (!window.confirm(`Удалить ${schema.formOptions.label}?`)) return;\n        props.store.api(`/admin/${modelName}/${model.id}/delete`).then(() => {\n            setModel(null)\n            getList(filter)\n        })\n    }\n\n    if (!schema) return <div></div>;\n    return <div key={modelName}>\n        {!model && <div>\n            <Button onClick={create} variant=\"primary\">создать \"{schema.formOptions.label}\"</Button>\n            <form onSubmit={search}>\n                <input name=\"search\"/>\n                <Button>Поиск</Button>\n                <Button type=\"cancel\">Х</Button>\n            </form>\n            <table className=\"table table-striped\">\n                <tbody>\n                {list.map(l => <tr key={l.id}>\n                    <td>\n                        <A key={l.id} href={`/admin/${modelName}/${l.id}/update`}\n                           className={`d-block ${model && l.id === model.id ? 'bg-success' : ''}`}>\n                            {schema.formOptions.listFields.map(f => l[f]).join(' - ') || l.id}</A>\n                    </td>\n                    <td>\n                        {l.image && <img src={l.photo} alt={l.id} height={20}/>}\n                    </td>\n                </tr>)}\n                </tbody>\n            </table>\n\n            Найдено: {totalCount}\n            {!!totalCount && <Pager key={totalCount} count={totalCount} filter={filter} onPageChange={pageChange}/>}\n        </div>}\n        {model && <div>\n            <Button onClick={() => navigate(`/admin/${modelName}`)} variant=\"warning\">Закрыть</Button>\n            <A href={model.link}>Смотреть</A>\n            <div className=\"row\">\n                <div className=\"col-10\">\n                    <Form validated={false} onSubmit={submit} key={model.id} onChange={() => setEdited(true)} className=\"form-model\">\n                        {edited && <Button type=\"submit\">Сохранить</Button>}\n                        <div className=\"admin-form-fields\">\n                            {schema.fields.map(f => <InputModel key={f.name} modelName={modelName} model={model} field={f} errors={errors} store={props.store}/>)}\n                        </div>\n                        {edited && <Button type=\"submit\">Сохранить</Button>}\n                    </Form>\n\n                </div>\n                <div className=\"col-2\">\n                    <img src={model.previewPath} alt={model.id} className=\"img-fluid\"/>\n                    <FileUpload uploadDone={uploadDone} store={props.store}/>\n                    {model.files && <FileList\n                        key={model.files.length}\n                        setPreview={setPreview}\n                        files={model.files.filter(i => i.isImage)}\n                        editable={true}\n                        store={props.store}/>}\n                </div>\n\n            </div>\n\n            <Button onClick={deleteModel} variant=\"danger\">Удалить</Button>\n        </div>}\n\n    </div>\n}\n"]},"metadata":{},"sourceType":"module"}